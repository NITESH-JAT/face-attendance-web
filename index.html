<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Face Attendance System</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto px-4 py-8">
  <div class="grid md:grid-cols-2 gap-6">
    <!-- Register Section -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-xl font-semibold text-blue-600 mb-4">ğŸ“‹ Register</h2>
      <input id="name" type="text" placeholder="Name" class="w-full mb-2 p-2 border rounded-lg" />
      <input id="roll" type="text" placeholder="Roll Number" class="w-full mb-2 p-2 border rounded-lg" />
      <input id="images" type="file" multiple accept="image/*" class="w-full mb-4" />
      <button id="registerBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Register</button>
      <p id="registerStatus" class="mt-2 text-sm text-green-600"></p>
    </div>

    <!-- Attendance Section -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-xl font-semibold text-blue-600 mb-4">ğŸ“· Take Attendance</h2>
      <input id="subject" type="text" placeholder="Subject" class="w-full mb-2 p-2 border rounded-lg" />
      <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Take Attendance</button>
      <div class="mt-4">
        <video id="video" width="320" height="240" autoplay muted class="border rounded-lg"></video>
      </div>
    </div>
  </div>

  <!-- Attendance Table -->
  <div class="bg-white p-6 mt-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold text-blue-600 mb-4">ğŸ“‘ Attendance Log</h2>
    <table class="min-w-full text-sm text-left border">
      <thead>
        <tr class="bg-blue-100">
          <th class="px-4 py-2">Name</th>
          <th class="px-4 py-2">Roll</th>
          <th class="px-4 py-2">Subject</th>
          <th class="px-4 py-2">Time</th>
        </tr>
      </thead>
      <tbody id="attendanceTable"></tbody>
    </table>
    <button id="downloadCSV" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-900">â¬‡ï¸ Download CSV</button>
  </div>
</div>

<script>
  const registerBtn = document.getElementById('registerBtn');
  const nameInput = document.getElementById('name');
  const rollInput = document.getElementById('roll');
  const imageInput = document.getElementById('images');
  const registerStatus = document.getElementById('registerStatus');
  const attendanceTable = document.getElementById('attendanceTable');
  const startBtn = document.getElementById('startBtn');
  const subjectInput = document.getElementById('subject');
  const video = document.getElementById('video');
  const downloadCSV = document.getElementById('downloadCSV');

  let students = JSON.parse(localStorage.getItem('students') || '[]');
  let attendanceLog = JSON.parse(localStorage.getItem('attendance') || '[]');

  function updateAttendanceTable() {
    attendanceTable.innerHTML = '';
    attendanceLog.slice(-10).forEach(entry => {
      const row = document.createElement('tr');
      row.innerHTML = `<td class="px-4 py-2">${entry.name}</td>
                       <td class="px-4 py-2">${entry.roll}</td>
                       <td class="px-4 py-2">${entry.subject}</td>
                       <td class="px-4 py-2">${entry.time}</td>`;
      attendanceTable.appendChild(row);
    });
  }

  registerBtn.onclick = () => {
    const name = nameInput.value.trim();
    const roll = rollInput.value.trim();
    const files = imageInput.files;

    if (!name || !roll || files.length !== 10) {
      registerStatus.textContent = "âš ï¸ Please fill all fields and upload exactly 10 images.";
      return;
    }

    const student = { name, roll, images: [] };

    const readerPromises = Array.from(files).map(file => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    });

    Promise.all(readerPromises).then(results => {
      student.images = results;
      students.push(student);
      localStorage.setItem('students', JSON.stringify(students));
      registerStatus.textContent = `âœ… ${name} registered successfully!`;
      nameInput.value = '';
      rollInput.value = '';
      imageInput.value = '';
    });
  };

  startBtn.onclick = async () => {
    const subject = subjectInput.value.trim();
    if (!subject) {
      alert("Enter subject!");
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    setTimeout(async () => {
      ctx.drawImage(video, 0, 0, 320, 240);
      const imageData = canvas.toDataURL();

      let matchFound = false;

      for (let student of students) {
        for (let img of student.images) {
          if (img.slice(0, 50) === imageData.slice(0, 50)) { // Simulated match
            const timeNow = new Date().toLocaleString();
            attendanceLog.push({ name: student.name, roll: student.roll, subject, time: timeNow });
            localStorage.setItem('attendance', JSON.stringify(attendanceLog));
            updateAttendanceTable();
            alert(`âœ… Attendance marked for ${student.name}`);
            matchFound = true;
            break;
          }
        }
        if (matchFound) break;
      }

      if (!matchFound) {
        alert("âŒ Face not recognized. Please register first.");
      }

      stream.getTracks().forEach(t => t.stop());
    }, 2000);
  };

  downloadCSV.onclick = () => {
    const csv = Papa.unparse(attendanceLog);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, 'attendance.csv');
  };

  updateAttendanceTable();
</script>
</body>
</html>
